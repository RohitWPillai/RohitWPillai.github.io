<script>
document.addEventListener('DOMContentLoaded', function() {
  'use strict';

  var aboutImage = document.querySelector('.quarto-about-solana .about-image');
  if (!aboutImage) return;

  // Wrap photo in mailto link (all viewports)
  var emailLink = document.createElement('a');
  emailLink.href = 'mailto:R.Pillai@ed.ac.uk';
  emailLink.setAttribute('aria-label', 'Send email');
  aboutImage.parentNode.insertBefore(emailLink, aboutImage);
  emailLink.appendChild(aboutImage);

  var aboutLinks = document.querySelector('.quarto-about-solana .about-links');
  if (!aboutLinks) return;

  // Icon class â†’ Unicode codepoint mapping (Bootstrap Icons)
  var iconMap = {
    'bi-github': '\uF3ED',
    'bi-mortarboard-fill': '\uF6FD',
    'bi-r-circle': '\uF80F',
    'bi-building': '\uF1DD',
    'bi-people-fill': '\uF4CF'
  };

  // Read links from existing Quarto-generated elements
  var linkEls = aboutLinks.querySelectorAll('.about-link');
  var links = [];
  for (var i = 0; i < linkEls.length; i++) {
    var textEl = linkEls[i].querySelector('.about-link-text');
    var iconEl = linkEls[i].querySelector('i[class*="bi-"]');
    var iconChar = '';
    if (iconEl) {
      var classes = iconEl.className.split(' ');
      for (var j = 0; j < classes.length; j++) {
        if (iconMap[classes[j]]) { iconChar = iconMap[classes[j]]; break; }
      }
    }
    links.push({
      text: (textEl ? textEl.textContent : '').toUpperCase(),
      href: linkEls[i].href,
      icon: iconChar
    });
  }
  if (links.length === 0) return;

  // SVG parameters
  var size = 500;
  var cx = size / 2, cy = size / 2;
  var textR = 220;
  var bgR = 220;
  var bgStroke = 40;
  var n = links.length;
  var gap = 6;
  var seg = (360 - n * gap) / n;
  var ns = 'http://www.w3.org/2000/svg';

  function p(r, angle) {
    var rad = (angle - 90) * Math.PI / 180;
    return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
  }

  function f(v) { return v.toFixed(2); }

  function arc(r, a1, a2, clockwise) {
    var start, end, sweep, diff;
    if (clockwise) {
      start = p(r, a1); end = p(r, a2); sweep = 1;
    } else {
      start = p(r, a2); end = p(r, a1); sweep = 0;
    }
    diff = ((a2 - a1) + 360) % 360;
    var large = diff > 180 ? 1 : 0;
    return 'M ' + f(start.x) + ' ' + f(start.y) +
           ' A ' + r + ' ' + r + ' 0 ' + large + ' ' + sweep +
           ' ' + f(end.x) + ' ' + f(end.y);
  }

  var svg = document.createElementNS(ns, 'svg');
  svg.setAttribute('viewBox', '0 0 ' + size + ' ' + size);
  svg.setAttribute('class', 'profile-halo');
  svg.setAttribute('role', 'navigation');
  svg.setAttribute('aria-label', 'Profile links');

  var defs = document.createElementNS(ns, 'defs');
  svg.appendChild(defs);

  var style = document.createElementNS(ns, 'style');
  style.textContent =
    '.halo-seg path.halo-bg { transition: stroke 0.3s ease; }' +
    '.halo-seg text { transition: fill 0.3s ease; cursor: pointer; }' +
    '.halo-seg:hover path.halo-bg { stroke: rgba(212, 160, 58, 0.35); }' +
    '.halo-seg:hover text { fill: #2d3047; }';
  svg.appendChild(style);

  for (var i = 0; i < links.length; i++) {
    var a1 = i * (seg + gap) + gap / 2;
    var a2 = a1 + seg;
    var mid = (a1 + a2) / 2;
    var normMid = ((mid % 360) + 360) % 360;

    // Top half clockwise, bottom half counter-clockwise
    var cw = (normMid <= 100 || normMid >= 300);

    // Background arc
    var bgPath = document.createElementNS(ns, 'path');
    bgPath.setAttribute('d', arc(bgR, a1, a2, true));
    bgPath.setAttribute('class', 'halo-bg');
    bgPath.setAttribute('fill', 'none');
    bgPath.setAttribute('stroke', 'rgba(212, 160, 58, 0.12)');
    bgPath.setAttribute('stroke-width', bgStroke);
    bgPath.setAttribute('stroke-linecap', 'round');

    // Text path
    var tpId = 'halo-tp-' + i;
    var tpPath = document.createElementNS(ns, 'path');
    tpPath.setAttribute('id', tpId);
    tpPath.setAttribute('d', arc(textR, a1, a2, cw));
    tpPath.setAttribute('fill', 'none');
    defs.appendChild(tpPath);

    // Text element
    var text = document.createElementNS(ns, 'text');
    text.setAttribute('fill', '#d4a03a');
    text.setAttribute('font-family', 'Inter, sans-serif');
    text.setAttribute('font-size', '15');
    text.setAttribute('font-weight', '600');
    text.setAttribute('letter-spacing', '2.5');

    var tp = document.createElementNS(ns, 'textPath');
    tp.setAttribute('href', '#' + tpId);
    tp.setAttribute('startOffset', '50%');
    tp.setAttribute('text-anchor', 'middle');

    // Add icon + text
    if (links[i].icon) {
      var iconSpan = document.createElementNS(ns, 'tspan');
      iconSpan.setAttribute('font-family', 'bootstrap-icons');
      iconSpan.setAttribute('font-size', '16.5');
      iconSpan.setAttribute('letter-spacing', '0');
      iconSpan.setAttribute('dy', '0.5');
      iconSpan.textContent = links[i].icon + ' ';
      tp.appendChild(iconSpan);
    }
    var labelSpan = document.createElementNS(ns, 'tspan');
    labelSpan.textContent = links[i].text;
    tp.appendChild(labelSpan);

    text.appendChild(tp);

    var anchor = document.createElementNS(ns, 'a');
    anchor.setAttribute('href', links[i].href);
    anchor.setAttribute('class', 'halo-seg');
    anchor.setAttribute('aria-label', links[i].text);
    anchor.appendChild(bgPath);
    anchor.appendChild(text);
    svg.appendChild(anchor);
  }

  // Position: wrap the email-linked image in halo wrapper and overlay SVG
  var imgParent = emailLink.parentNode;
  var wrapper = document.createElement('div');
  wrapper.className = 'halo-img-wrapper';
  imgParent.insertBefore(wrapper, emailLink);
  wrapper.appendChild(emailLink);
  wrapper.appendChild(svg);

  // Hide the original pill buttons
  aboutLinks.classList.add('halo-active');
});
</script>
